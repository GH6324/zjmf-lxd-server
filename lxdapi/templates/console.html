<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>LXD 容器控制台 - {{.Hostname}}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <!-- XTerm CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fc;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            padding-top: 2rem;
        }
        .container-fluid {
            max-width: 1200px;
            margin: 0 auto;
            padding-left: 2rem;
            padding-right: 2rem;
        }
        .card {
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            border: 1px solid #e3e6f0;
        }
        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
        }
        .border-left-primary {
            border-left: .25rem solid #4e73df!important;
        }
        .text-primary {
            color: #4e73df!important;
        }
        .badge-success {
            background-color: #1cc88a;
        }
        .badge-warning {
            background-color: #f6c23e;
        }
        .badge-danger {
            background-color: #e74a3b;
        }
        #terminal-container {
            height: calc(100vh - 300px);
            min-height: 400px;
            background: #000;
            border-radius: 0.35rem;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-connected {
            background-color: #1cc88a;
            animation: pulse 2s infinite;
        }
        .status-connecting {
            background-color: #f6c23e;
        }
        .status-disconnected {
            background-color: #e74a3b;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .btn-primary {
            background-color: #4e73df;
            border-color: #4e73df;
        }
        .btn-secondary {
            background-color: #858796;
            border-color: #858796;
        }
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        .alert {
            border-radius: 0.35rem;
            border: 1px solid transparent;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">

                <!-- 控制台卡片 -->
                <div class="card shadow mb-4 border-left-primary">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-terminal mr-2"></i>LXD 容器控制台
                            </h6>
                            <small class="text-muted">容器: {{.Hostname}} | 令牌: {{.Token}}</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="status-indicator status-disconnected" id="status-indicator"></span>
                            <span id="status-text" class="badge badge-danger">未连接</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="terminal-container"></div>
                    </div>
                    <div class="card-footer bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button class="btn btn-primary btn-sm" id="connect-btn" onclick="connectConsole()">
                                    <i class="fas fa-plug mr-1"></i>连接
                                </button>
                                <button class="btn btn-secondary btn-sm ml-2" onclick="clearTerminal()">
                                    <i class="fas fa-eraser mr-1"></i>清屏
                                </button>
                                <button class="btn btn-success btn-sm ml-2" onclick="sendYes()">
                                    <i class="fas fa-check mr-1"></i>Y
                                </button>
                                <button class="btn btn-danger btn-sm ml-2" onclick="sendNo()">
                                    <i class="fas fa-times mr-1"></i>N
                                </button>
                                <button class="btn btn-secondary btn-sm ml-2" onclick="resizeTerminal()">
                                    <i class="fas fa-expand-arrows-alt mr-1"></i>调整大小
                                </button>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                使用 Ctrl+C 中断命令，Ctrl+D 退出会话
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 固定在底部的重要提示 -->
    <div class="fixed-bottom bg-warning text-dark p-2 text-center" style="z-index: 1050;">
        <small>
            <i class="fas fa-exclamation-triangle mr-1"></i>
            <strong>重要提示：</strong>此控制台链接仅支持单次连接，断开连接后需要重新点击VNC按钮获取新的访问令牌。
        </small>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- XTerm JS -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script>
        let terminal = null;
        let websocket = null;
        let fitAddon = null;
        let isConnected = false;
        const wsUrl = '{{.WSUrl}}';

        // 初始化终端 - 简化配置
        function initTerminal() {
            terminal = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: 'Consolas, "Courier New", monospace',
                theme: {
                    background: '#000000',
                    foreground: '#ffffff',
                    cursor: '#ffffff'
                },
                convertEol: true,
                scrollback: 1000
            });

            fitAddon = new FitAddon.FitAddon();
            terminal.loadAddon(fitAddon);
            terminal.open(document.getElementById('terminal-container'));

            // 监听用户输入
            terminal.onData(data => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    // 直接发送数据，不做额外的换行处理
                    websocket.send(JSON.stringify({
                        type: 'input',
                        data: data
                    }));
                }
            });

            // 初始调整大小
            setTimeout(() => {
                fitAddon.fit();
            }, 100);

            // 窗口大小变化时自动调整
            window.addEventListener('resize', () => {
                setTimeout(() => {
                    if (fitAddon && terminal) {
                        fitAddon.fit();
                    }
                }, 100);
            });

            // 使用ResizeObserver监听容器大小变化
            if (window.ResizeObserver) {
                const resizeObserver = new ResizeObserver(() => {
                    setTimeout(() => {
                        if (fitAddon && terminal) {
                            fitAddon.fit();
                        }
                    }, 50);
                });
                resizeObserver.observe(document.getElementById('terminal-container'));
            }

            terminal.writeln('\x1b[33m点击"连接"按钮开始...\x1b[0m');
            terminal.writeln('');
        }

        // 连接控制台
        function connectConsole() {
            if (!terminal) {
                initTerminal();
            }

            updateStatus('connecting', '正在连接...');

            websocket = new WebSocket(wsUrl);

            websocket.onopen = function() {
                isConnected = true;
                updateStatus('connected', '已连接');
                document.getElementById('connect-btn').textContent = '断开';
                document.getElementById('connect-btn').onclick = disconnectConsole;

                // 只显示连接成功信息，不清屏
                terminal.writeln('\x1b[32m✓ 连接成功\x1b[0m');
            };

            websocket.onmessage = function(event) {
                if (terminal && event.data) {
                    terminal.write(event.data);
                }
            };

            websocket.onclose = function() {
                isConnected = false;
                updateStatus('disconnected', '连接已断开');
                document.getElementById('connect-btn').textContent = '重新连接';
                document.getElementById('connect-btn').onclick = connectConsole;
                if (terminal) {
                    terminal.writeln('\r\n\x1b[33m✗ 连接已断开\x1b[0m');
                }
            };

            websocket.onerror = function(error) {
                updateStatus('error', '连接错误');
                if (terminal) {
                    terminal.writeln('\r\n\x1b[31m✗ 连接错误\x1b[0m');
                }
            };

            // 终端输入已在initTerminal中处理
        }

        // 断开连接
        function disconnectConsole() {
            if (websocket) {
                websocket.close();
            }
        }

        // 更新状态
        function updateStatus(status, text) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');

            // 移除所有状态类
            indicator.className = 'status-indicator';
            statusText.className = 'badge';

            // 添加新的状态类
            switch(status) {
                case 'connected':
                    indicator.classList.add('status-connected');
                    statusText.classList.add('badge-success');
                    break;
                case 'connecting':
                    indicator.classList.add('status-connecting');
                    statusText.classList.add('badge-warning');
                    break;
                case 'disconnected':
                case 'error':
                default:
                    indicator.classList.add('status-disconnected');
                    statusText.classList.add('badge-danger');
                    break;
            }

            statusText.textContent = text;
        }

        // 清屏
        function clearTerminal() {
            if (terminal) {
                terminal.clear();
                // 如果已连接，发送clear命令到shell
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({
                        type: 'input',
                        data: 'clear\n'
                    }));
                }
            }
        }

        // 发送Y确认
        function sendYes() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'input',
                    data: 'Y\n'
                }));
            }
        }

        // 发送N拒绝
        function sendNo() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'input',
                    data: 'N\n'
                }));
            }
        }

        // 调整大小
        function resizeTerminal() {
            if (fitAddon && terminal) {
                setTimeout(() => {
                    fitAddon.fit();
                    // 静默调整，不显示额外信息
                }, 100);
            }
        }

        // 页面加载完成后初始化
        window.onload = function() {
            initTerminal();
        };
    </script>
</body>
</html>