<style>
/* 简洁专业设计风格 */

.resource-card {
    border: 1px solid #e1e5e9;
    border-radius: 6px;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.2s ease;
}

.resource-card:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

.resource-header {
    color: #495057;
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 8px;
}

.resource-header i {
    color: #6c757d;
    margin-right: 6px;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .resource-grid {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(4, auto);
        gap: 12px;
        min-height: auto;
    }
    
    .resource-grid-item {
        padding: 14px;
    }
    
    .resource-value {
        font-size: 1.25rem;
        margin-bottom: 10px;
    }
    
    .resource-header {
        font-size: 0.8rem;
    }
    
    .progress {
        height: 5px;
    }
}

.resource-value.text-primary {
    color: #007bff !important;
}

.resource-value.text-success {
    color: #28a745 !important;
}

.resource-value.text-info {
    color: #17a2b8 !important;
}

.resource-value.text-warning {
    color: #ffc107 !important;
}

.progress {
    height: 6px;
    border-radius: 4px;
    background-color: #e9ecef;
    border: 1px solid #dee2e6;
}

.progress-bar {
    border-radius: 3px;
    transition: width 0.3s ease;
    height: 100%;
}

.progress-primary {
    background-color: #007bff !important;
}

.progress-success {
    background-color: #28a745 !important;
}

.progress-info {
    background-color: #17a2b8 !important;
}

.progress-warning {
    background-color: #ffc107 !important;
}

.progress-danger {
    background-color: #dc3545 !important;
}

.resource-icon {
    opacity: 0.2;
    color: #6c757d;
}

.badge {
    font-size: 0.8rem;
    font-weight: 500;
    padding: 4px 8px;
    border-radius: 4px;
}

.badge-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.badge-secondary {
    background: #6c757d;
    color: white;
}

.badge-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

/* 田字格样式 - 更紧凑的布局 */
.resource-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 16px;
    min-height: 260px;
}

.resource-grid-item {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 16px;
    height: 100%;
}

.resource-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 8px;
    min-height: 1.8rem;
    display: flex;
    align-items: center;
}
</style>

<div class="container-fluid">
<!-- 容器状态监控 -->
<div class="card shadow mb-4">
    <div class="card-header d-flex justify-content-between align-items-center py-3">
        <div>
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-tachometer-alt mr-2"></i>容器状态监控
            </h6>
            <small class="text-muted">实时显示容器资源使用情况</small>
            <span class="badge badge-info mt-1">
                最后更新: <span id="last-update">刚刚</span>
            </span>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="refreshInfoPage()">
            <i class="fas fa-sync-alt mr-1"></i>刷新
        </button>
    </div>
    <div class="card-body">
        <div class="resource-grid">
            <div class="card resource-card resource-grid-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="resource-header">
                            <i class="fas fa-microchip"></i>CPU使用率
                        </div>
                        <div class="resource-value text-primary" id="cpu-info">
                            加载中...
                        </div>
                    </div>
                    <i class="fas fa-microchip fa-2x resource-icon"></i>
                </div>
                <div class="progress">
                    <div class="progress-bar progress-primary" style="width: 0%" id="cpu-progress"></div>
                </div>
            </div>
            
            <div class="card resource-card resource-grid-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="resource-header">
                            <i class="fas fa-memory"></i>内存使用
                        </div>
                        <div class="resource-value text-success" id="memory-info">
                            加载中...
                        </div>
                    </div>
                    <i class="fas fa-memory fa-2x resource-icon"></i>
                </div>
                <div class="progress">
                    <div class="progress-bar progress-success" style="width: 0%" id="memory-progress"></div>
                </div>
            </div>
            
            <div class="card resource-card resource-grid-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="resource-header">
                            <i class="fas fa-hdd"></i>硬盘使用
                        </div>
                        <div class="resource-value text-info" id="disk-info">
                            加载中...
                        </div>
                    </div>
                    <i class="fas fa-hdd fa-2x resource-icon"></i>
                </div>
                <div class="progress">
                    <div class="progress-bar progress-info" style="width: 0%" id="disk-progress"></div>
                </div>
            </div>
            
            <div class="card resource-card resource-grid-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="resource-header">
                            <i class="fas fa-exchange-alt"></i>流量使用
                        </div>
                        <div class="resource-value text-warning" id="traffic-info">
                            加载中...
                        </div>
                    </div>
                    <i class="fas fa-exchange-alt fa-2x resource-icon"></i>
                </div>
                <div class="progress">
                    <div class="progress-bar progress-warning" style="width: 0%" id="traffic-progress"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 使用说明 -->
<div class="card shadow">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-question-circle mr-2"></i>使用说明
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-key text-success mr-2"></i><strong>初始密码:</strong> 已在开通时设置，可直接登录</li>
                    <li class="mb-2"><i class="fas fa-clock text-warning mr-2"></i><strong>响应时间:</strong> 部分操作响应较慢，请耐心等待</li>
                    <li class="mb-2"><i class="fas fa-cog text-secondary mr-2"></i><strong>SSH端口:</strong> SSH端口转发已自动配置</li>
                </ul>
            </div>
            <div class="col-md-6">
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-sync-alt text-primary mr-2"></i>数据攧5秒自动刷新一次</li>
                    <li class="mb-2"><i class="fas fa-mouse-pointer text-info mr-2"></i>点击刷新按钮可手动更新数据</li>
                    <li class="mb-2"><i class="fas fa-chart-bar text-danger mr-2"></i>资源使用率超过90%时请注意监控</li>
                </ul>
            </div>
        </div>
    </div>
</div>
</div>

<script>
// INFO调试模式开关
const INFO_DEBUG_MODE = false;

// 全局变量
var currentInfoContainerId = '';

function infoDebug(message, data) {
    if (INFO_DEBUG_MODE) {
        console.log('[INFO-DEBUG]', message, data);
    }
}

// 刷新信息页面（AJAX方式，不刷新整个页面）
function refreshInfoPage() {
    infoDebug('手动刷新信息页面');
    updateLastUpdateTime();
    loadContainerInfo();
}

// 暴露到全局，兼容调用
window.refreshInfoPage = refreshInfoPage;

// 更新最后更新时间
function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', {
        hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    const lastUpdateElement = document.getElementById('last-update');
    if (lastUpdateElement) {
        lastUpdateElement.textContent = timeString;
    }
}

function loadContainerInfo() {
    // 如果已有容器ID，直接使用；否则从URL获取
    if (!currentInfoContainerId) {
        const urlParams = new URLSearchParams(window.location.search);
        const containerId = urlParams.get('id');

        if (!containerId) {
            showError('无法获取容器ID');
            return;
        }
        currentInfoContainerId = containerId;
    }

    $('#last-update').html('<i class="fas fa-spinner fa-spin"></i> 更新中...');
    loadAllInfoData(currentInfoContainerId);
}

function loadAllInfoData(containerId) {
    const timestamp = new Date().getTime();
    const infoUrl = `/provision/custom/content?id=${containerId}&key=info&action=getinfoall&_t=${timestamp}`;

    infoDebug('API请求', infoUrl);

    $.ajax({
        url: infoUrl,
        method: 'GET',
        dataType: 'json',
        timeout: 10000,
        cache: false,
        success: function(response) {
            infoDebug('API响应', response);
            if (response && response.code === 200 && response.data) {
                updateAllInfo(response.data);
            } else {
                showError(response.msg || '获取容器信息失败');
            }
        },
        error: function(xhr, status, error) {
            infoDebug('API请求失败', {status: xhr.status, error: error});
            showError('网络请求失败: ' + error);
        }
    });
}

function updateAllInfo(data) {
    // 更新CPU信息
    const cpuUsage = data.cpu_usage || 0;
    const cpuCores = data.cpus || 'N/A';
    const cpuUsageFormatted = parseFloat(cpuUsage).toFixed(1);
    $('#cpu-info').text(`${cpuUsageFormatted}% (${cpuCores} Core)`);
    $('#cpu-progress').css('width', Math.min(parseFloat(cpuUsage) || 0, 100) + '%');

    // 更新内存信息
    const memoryUsage = data.memory_usage || 'N/A';
    const memoryTotal = (data.config && data.config.memory) || 'N/A';
    const memoryPercent = parseFloat(data.memory_percent) || 0;
    $('#memory-info').text(`${memoryUsage} / ${memoryTotal}`);
    $('#memory-progress').css('width', Math.min(memoryPercent, 100) + '%');

    // 直接显示配置值，不进行单位转换
    function formatDiskSize(value) {
        if (typeof value === 'string') {
            return value; // 直接返回配置中的字符串值
        }
        
        const num = parseFloat(value);
        if (isNaN(num)) return 'N/A';
        
        return num + ' MB'; // 数字值默认按MB处理
    }

    // 更新硬盘信息
    const diskUsage = data.disk_usage || 'N/A';
    let diskTotal = 'N/A';
    
    // 处理硬盘总量显示
    if (data.config && data.config.disk) {
        diskTotal = formatDiskSize(data.config.disk);
    } else if (data.disk) {
        diskTotal = formatDiskSize(data.disk);
    }
    
    const diskPercent = parseFloat(data.disk_percent) || 0;
    $('#disk-info').text(`${diskUsage} / ${diskTotal}`);
    $('#disk-progress').css('width', Math.min(diskPercent, 100) + '%');

    // 更新流量信息
    const trafficUsage = data.traffic_usage || 'N/A';
    const trafficUsageRaw = data.traffic_usage_raw || 0;
    const trafficLimit = data.config && data.config.traffic_limit ? data.config.traffic_limit : 0;
    
    if (trafficLimit > 0) {
        // 有流量限制：显示 已用/限制
        const trafficLimitGB = trafficLimit;
        const trafficUsageGB = (trafficUsageRaw / (1024 * 1024 * 1024)).toFixed(2);
        const trafficPercent = Math.min((parseFloat(trafficUsageGB) / trafficLimitGB) * 100, 100);
        
        $('#traffic-info').text(`${trafficUsageGB} GB / ${trafficLimitGB} GB`);
        $('#traffic-progress').css('width', trafficPercent + '%');
        
        // 流量超限时显示警告样式
        if (trafficPercent >= 100) {
            $('#traffic-progress').removeClass('progress-warning').addClass('progress-danger');
        } else if (trafficPercent >= 80) {
            $('#traffic-progress').removeClass('progress-danger').addClass('progress-warning');
        } else {
            $('#traffic-progress').removeClass('progress-danger').addClass('progress-warning');
        }
    } else {
        // 无流量限制：只显示累计流量
        $('#traffic-info').text(`累计: ${trafficUsage}`);
        $('#traffic-progress').css('width', '10%');
        $('#traffic-progress').removeClass('progress-danger').addClass('progress-warning');
    }

    // 更新时间
    if (data.last_update) {
        $('#last-update').text(data.last_update);
    } else {
        updateLastUpdateTime();
    }
}

function showError(message) {
    $('#cpu-info').text('加载失败');
    $('#memory-info').text('加载失败');
    $('#disk-info').text('加载失败');
    $('#traffic-info').text('加载失败');

    // 显示错误时间
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', {
        hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    $('#last-update').text(`${timeString} (错误)`);
    infoDebug('加载错误', message);
}

$(document).ready(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const containerId = urlParams.get('id');

    if (!containerId) {
        showError('无法获取容器ID');
        return;
    }

    // 设置全局容器ID
    currentInfoContainerId = containerId;
    infoDebug('设置容器ID', containerId);

    // 初始化时间显示
    updateLastUpdateTime();

    // 首次加载
    loadContainerInfo();

    // 每5秒自动刷新
    setInterval(function() {
        infoDebug('定时器触发，刷新容器信息');
        loadContainerInfo();
    }, 5000);
});
</script>