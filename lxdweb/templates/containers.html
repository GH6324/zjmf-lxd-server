<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-gray-50">
    {{template "header.html" .}}
    
    <!-- 创建容器模态框 -->
    <div id="createContainerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" onclick="if(event.target === this) closeCreateContainer()">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-indigo-600 to-indigo-700">
                <h2 class="text-xl font-bold text-white">创建新容器</h2>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
                <form id="createContainerForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">容器名称 *</label>
                            <input type="text" name="hostname" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如: web01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">节点 *</label>
                            <select name="node_id" required id="createNodeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">选择节点</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">密码 *</label>
                            <input type="text" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="容器root密码">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">镜像 *</label>
                            <input type="text" name="image" required value="debian12" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如: debian12">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">CPU核心数</label>
                            <input type="number" name="cpus" value="1" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">内存</label>
                            <input type="text" name="memory" value="512MB" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如: 512MB">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">硬盘</label>
                            <input type="text" name="disk" value="10GB" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如: 10GB">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">入站带宽</label>
                            <input type="text" name="ingress" value="100Mbit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如: 100Mbit">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">出站带宽</label>
                            <input type="text" name="egress" value="100Mbit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如: 100Mbit">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">月流量限制(GB)</label>
                            <input type="number" name="traffic_limit" value="100" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" name="allow_nesting" class="mr-2">
                                <span class="text-sm text-gray-700">允许容器嵌套</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" name="memory_swap" checked class="mr-2">
                                <span class="text-sm text-gray-700">启用内存交换</span>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-2">
                <button onclick="closeCreateContainer()" class="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-100 transition">取消</button>
                <button onclick="submitCreateContainer()" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">创建容器</button>
            </div>
        </div>
    </div>

    <!-- 容器详情模态框 -->
    <div id="containerDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" onclick="if(event.target === this) closeContainerDetail()">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-indigo-600 to-indigo-700">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    容器详情 - <span id="detailHostname"></span>
                </h2>
                <div class="flex items-center gap-2">
                    <button onclick="manualRefreshDetail()" class="px-3 py-1 text-sm bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded transition" title="手动刷新">
                        刷新
                    </button>
                    <button onclick="closeContainerDetail()" class="text-white hover:text-gray-200 text-2xl leading-none">&times;</button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                <div id="detailContent" class="text-center py-8">
                    <span class="loading loading-spinner loading-lg text-indigo-600"></span>
                    <p class="text-gray-600 mt-2">加载中...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">容器管理</h1>
                <div class="flex items-center gap-3 mt-1">
                    <p class="text-gray-600">监控和管理所有LXD容器</p>
                    <div id="syncStatusIndicator" class="hidden">
                        <span class="flex items-center gap-2 text-sm text-blue-600">
                            <span class="loading loading-spinner loading-xs"></span>
                            <span id="syncStatusText">正在同步中...</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="showCreateContainer()" class="btn-action bg-indigo-500 hover:bg-indigo-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span>创建容器</span>
                </button>
                <button onclick="loadContainers()" class="btn-action bg-gray-500 hover:bg-gray-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>刷新页面</span>
                </button>
                <button onclick="syncCurrentNode()" id="syncAllBtn" class="btn-action bg-green-500 hover:bg-green-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                    <span>同步当前节点</span>
                </button>
                <button onclick="showSyncHistory()" class="btn-action bg-blue-500 hover:bg-blue-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>同步历史</span>
            </button>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">节点筛选:</label>
                    <select id="nodeFilter" onchange="filterContainers()" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                        <option value="">全部节点</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">状态筛选:</label>
                    <select id="statusFilter" onchange="filterContainers()" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                        <option value="">全部状态</option>
                        <option value="Running">运行中</option>
                        <option value="Stopped">已停止</option>
                        <option value="Frozen">已冻结</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 flex-1">
                    <label class="text-sm font-medium text-gray-700">搜索:</label>
                    <input type="text" id="searchInput" oninput="filterContainers()" placeholder="容器名称或IP" class="px-3 py-1 border border-gray-300 rounded-lg text-sm flex-1 max-w-xs">
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">每页:</label>
                    <select id="pageSize" onchange="changePageSize()" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                        <option value="25">25条</option>
                        <option value="50" selected>50条</option>
                        <option value="100">100条</option>
                        <option value="300">300条</option>
                    </select>
                </div>
                <div class="flex gap-6 ml-auto">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-800" id="totalCount">0</div>
                        <div class="text-xs text-gray-500">总容器</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="runningCount">0</div>
                        <div class="text-xs text-gray-500">运行中</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-600" id="stoppedCount">0</div>
                        <div class="text-xs text-gray-500">已停止</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <div class="overflow-x-auto">
                    <table class="table table-zebra table-sm">
                        <thead>
                            <tr>
                                <th onclick="sortBy('hostname')" class="cursor-pointer hover:bg-gray-100">
                                    容器名称 <span class="sort-icon">⇅</span>
                                </th>
                                <th>节点</th>
                                <th onclick="sortBy('status')" class="cursor-pointer hover:bg-gray-100">
                                    状态 <span class="sort-icon">⇅</span>
                                </th>
                                <th>IP地址</th>
                                <th onclick="sortBy('cpu_usage')" class="cursor-pointer hover:bg-gray-100">
                                    CPU <span class="sort-icon">⇅</span>
                                </th>
                                <th onclick="sortBy('memory_usage')" class="cursor-pointer hover:bg-gray-100">
                                    内存 <span class="sort-icon">⇅</span>
                                </th>
                                <th onclick="sortBy('disk_usage')" class="cursor-pointer hover:bg-gray-100">
                                    硬盘 <span class="sort-icon">⇅</span>
                                </th>
                                <th onclick="sortBy('traffic_total')" class="cursor-pointer hover:bg-gray-100">
                                    流量 <span class="sort-icon">⇅</span>
                                </th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="containerTableBody">
                            <tr>
                                <td colspan="9" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 分页控件 -->
            <div class="border-t px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-600">
                        显示第 <span id="pageStartNum">0</span> - <span id="pageEndNum">0</span> 条，共 <span id="filteredCount">0</span> 条
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="goToPage(1)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" id="firstPageBtn">
                            首页
                        </button>
                        <button onclick="goToPage(currentPage - 1)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" id="prevPageBtn">
                            上一页
                        </button>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">第</span>
                            <input type="number" id="pageInput" min="1" value="1" class="w-16 px-2 py-1 text-sm text-center border border-gray-300 rounded" onkeypress="handlePageInputEnter(event)">
                            <span class="text-sm text-gray-600">/ <span id="totalPages">1</span> 页</span>
                            <button onclick="goToInputPage()" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                跳转
                            </button>
                        </div>
                        <button onclick="goToPage(currentPage + 1)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" id="nextPageBtn">
                            下一页
                        </button>
                        <button onclick="goToPage(totalPagesCount)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" id="lastPageBtn">
                            末页
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
        /* 统一按钮样式 */
        .btn-action {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            border-radius: 0.5rem;
            transition: all 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .btn-action:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-action svg {
            flex-shrink: 0;
        }
        
        .sort-icon {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
    </style>
    <script>
        let nodes = [];
        let allContainers = [];
        let filteredContainers = [];
        let currentSort = {field: 'hostname', asc: true};
        let currentPage = 1;
        let pageSize = 50;
        let totalPagesCount = 1;
        
        $(document).ready(function() {
            loadNodes();
            loadContainers();
        });
        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        function getProgressColor(percent) {
            if (percent >= 90) return '#ef4444';
            if (percent >= 75) return '#f59e0b';
            if (percent >= 50) return '#3b82f6';
            return '#10b981';
        }
        function renderProgress(value, total) {
            if (!value || !total) return '<span class="text-gray-400 text-xs">-</span>';
            const percent = (value / total * 100).toFixed(1);
            const color = getProgressColor(percent);
            return `
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%; background: ${color}"></div>
                </div>
            `;
        }
        function renderContainers(containers) {
            filteredContainers = containers;
            
            // 计算总页数
            totalPagesCount = Math.ceil(containers.length / pageSize);
            if (totalPagesCount === 0) totalPagesCount = 1;
            
            // 确保当前页不超过总页数
            if (currentPage > totalPagesCount) {
                currentPage = totalPagesCount;
            }
            
            // 更新统计信息
            updateStats(containers);
            
            // 更新分页信息
            updatePaginationInfo(containers.length);
            
            // 计算当前页数据
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, containers.length);
            const pageContainers = containers.slice(startIndex, endIndex);
            
            if (pageContainers.length === 0) {
                $('#containerTableBody').html('<tr><td colspan="9" class="text-center text-gray-500">暂无容器数据</td></tr>');
                return;
            }
            
            const rows = pageContainers.map(c => {
                const badges = {
                    'Running': '<span class="badge badge-success badge-sm gap-1">运行中</span>',
                    'Stopped': '<span class="badge badge-ghost badge-sm gap-1">已停止</span>',
                    'Frozen': '<span class="badge badge-info badge-sm gap-1">已冻结</span>'
                };
                const badge = badges[c.status] || badges.Stopped;
                
                // CPU: 显示核心数和百分比
                const cpuCores = c.cpus || 1;
                const cpuPercent = c.cpu_usage ? parseFloat(c.cpu_usage).toFixed(1) : 0;
                const cpuDisplay = `<div class="text-xs font-medium ${cpuPercent > 80 ? 'text-red-600' : 'text-gray-700'}">${cpuCores}核 (${cpuPercent}%)</div>`;
                
                // 内存: 显示百分比 + 使用量/总量 + 进度条
                const memoryUsage = c.memory_usage_raw ?? c.memory_usage;
                const memoryTotal = c.memory_total ?? (c.memory ? c.memory * 1024 * 1024 : null);
                const memoryDisplay = (memoryUsage != null && memoryTotal != null) 
                    ? (() => {
                        const percent = (memoryUsage / memoryTotal * 100).toFixed(1);
                        return `<div class="text-xs text-gray-600 mb-1">${percent}% | ${formatBytes(memoryUsage)} / ${formatBytes(memoryTotal)}</div>` + renderProgress(memoryUsage, memoryTotal);
                    })()
                    : '<span class="text-gray-400 text-xs">-</span>';
                
                // 磁盘: 显示百分比 + 使用量/总量 + 进度条
                const diskUsage = c.disk_usage_raw ?? c.disk_usage;
                const diskTotal = c.disk_total ?? (c.disk ? c.disk * 1024 * 1024 : null);
                const diskDisplay = (diskUsage != null && diskTotal != null)
                    ? (() => {
                        const percent = (diskUsage / diskTotal * 100).toFixed(1);
                        return `<div class="text-xs text-gray-600 mb-1">${percent}% | ${formatBytes(diskUsage)} / ${formatBytes(diskTotal)}</div>` + renderProgress(diskUsage, diskTotal);
                    })()
                    : '<span class="text-gray-400 text-xs">-</span>';
                
                // 流量: 显示百分比 + 使用量/限额 + 进度条
                const trafficUsage = c.traffic_usage_raw ?? c.traffic_total;
                const trafficLimit = c.config?.traffic_limit ?? c.traffic_limit;
                const trafficDisplay = (trafficUsage != null && trafficLimit != null) 
                    ? (() => {
                        const percent = (trafficUsage / (trafficLimit * 1024 * 1024 * 1024) * 100).toFixed(1);
                        return `<div class="text-xs text-gray-600 mb-1">${percent}% | ${formatBytes(trafficUsage)} / ${trafficLimit} GB</div>` + renderProgress(trafficUsage, trafficLimit * 1024 * 1024 * 1024);
                    })()
                    : '<span class="text-gray-400 text-xs">-</span>';
                return `
                    <tr class="hover:bg-gray-50">
                        <td>
                            <div class="font-semibold text-gray-800 text-sm">${c.hostname}</div>
                            <div class="text-xs text-gray-500">
                                ${c.last_sync ? '同步: ' + formatSyncTime(c.last_sync) : '未同步'}
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-outline badge-xs">${c.node_name}</span>
                        </td>
                        <td>${badge}</td>
                        <td class="text-xs">
                            ${c.ipv4 ? `<code class="bg-blue-50 px-1 py-0.5 rounded">${c.ipv4}</code>` : '<span class="text-gray-400">-</span>'}
                        </td>
                        <td>${cpuDisplay}</td>
                        <td style="min-width: 140px">${memoryDisplay}</td>
                        <td style="min-width: 140px">${diskDisplay}</td>
                        <td style="min-width: 140px">${trafficDisplay}</td>
                        <td>
                            <div class="flex gap-1 flex-wrap">
                                <button onclick="showContainerDetail('${c.hostname}', ${c.node_id})" class="px-3 py-1 text-xs text-white bg-indigo-600 hover:bg-indigo-700 rounded transition">详情</button>
                                <button onclick="refreshSingleContainer('${c.hostname}', ${c.node_id})" class="px-3 py-1 text-xs text-white bg-gray-600 hover:bg-gray-700 rounded transition">刷新</button>
                                <button onclick="startContainer('${c.hostname}', ${c.node_id})" class="px-3 py-1 text-xs text-white bg-green-600 hover:bg-green-700 rounded transition">启动</button>
                                <button onclick="stopContainer('${c.hostname}', ${c.node_id})" class="px-3 py-1 text-xs text-white bg-orange-600 hover:bg-orange-700 rounded transition">停止</button>
                                <button onclick="restartContainer('${c.hostname}', ${c.node_id})" class="px-3 py-1 text-xs text-white bg-blue-600 hover:bg-blue-700 rounded transition">重启</button>
                                <button onclick="openConsole('${c.hostname}', ${c.node_id})" class="px-3 py-1 text-xs text-white bg-purple-600 hover:bg-purple-700 rounded transition" ${c.status !== 'Running' ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>控制台</button>
                                <button onclick="deleteContainer('${c.hostname}', ${c.node_id})" class="px-3 py-1 text-xs text-white bg-red-600 hover:bg-red-700 rounded transition">删除</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            $('#containerTableBody').html(rows);
        }
        
        function updatePaginationInfo(totalCount) {
            const startNum = totalCount === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const endNum = Math.min(currentPage * pageSize, totalCount);
            
            $('#pageStartNum').text(startNum);
            $('#pageEndNum').text(endNum);
            $('#filteredCount').text(totalCount);
            $('#totalPages').text(totalPagesCount);
            $('#pageInput').val(currentPage);
            $('#pageInput').attr('max', totalPagesCount);
            
            // 更新按钮状态
            $('#firstPageBtn, #prevPageBtn').prop('disabled', currentPage === 1);
            $('#nextPageBtn, #lastPageBtn').prop('disabled', currentPage === totalPagesCount);
        }
        
        function changePageSize() {
            pageSize = parseInt($('#pageSize').val());
            currentPage = 1;
            renderContainers(filteredContainers);
        }
        
        function goToPage(page) {
            if (page < 1 || page > totalPagesCount) return;
            currentPage = page;
            renderContainers(filteredContainers);
            // 平滑滚动到表格顶部
            $('html, body').animate({
                scrollTop: $('.bg-white.rounded-lg.shadow').offset().top - 100
            }, 300);
        }
        
        function goToInputPage() {
            const page = parseInt($('#pageInput').val());
            if (!isNaN(page)) {
                goToPage(page);
            }
        }
        
        function handlePageInputEnter(event) {
            if (event.keyCode === 13) {
                goToInputPage();
            }
        }
        function sortBy(field) {
            if (currentSort.field === field) {
                currentSort.asc = !currentSort.asc;
            } else {
                currentSort.field = field;
                currentSort.asc = true;
            }
            allContainers.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                } else if (typeof aVal === 'undefined') {
                    aVal = 0;
                    bVal = bVal || 0;
                }
                if (currentSort.asc) {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            currentPage = 1;
            filterContainers();
        }
        function updateStats(containers) {
            const total = containers.length;
            const running = containers.filter(c => c.status === 'Running').length;
            const stopped = containers.filter(c => c.status === 'Stopped').length;
            $('#totalCount').text(total);
            $('#runningCount').text(running);
            $('#stoppedCount').text(stopped);
        }
        function filterContainers() {
            const nodeFilter = $('#nodeFilter').val();
            const statusFilter = $('#statusFilter').val();
            const searchText = $('#searchInput').val().toLowerCase();
            let filtered = allContainers;
            if (nodeFilter) {
                filtered = filtered.filter(c => c.node_id == nodeFilter);
            }
            if (statusFilter) {
                filtered = filtered.filter(c => c.status === statusFilter);
            }
            if (searchText) {
                filtered = filtered.filter(c => 
                    c.hostname.toLowerCase().includes(searchText) ||
                    (c.ipv4 && c.ipv4.includes(searchText)) ||
                    (c.ipv6 && c.ipv6.includes(searchText))
                );
            }
            currentPage = 1; // 筛选后重置到第一页
            renderContainers(filtered);
        }
        function loadNodes() {
            $.get('/api/nodes', function(result) {
                if (result.code === 200) {
                    nodes = result.data;
                    const activeNodes = nodes.filter(n => n.status === 'active');
                    const createOptions = '<option value="">请选择节点</option>' + 
                        activeNodes.map(n => `<option value="${n.id}">${n.name}</option>`).join('');
                    $('#createNodeId').html(createOptions);
                    const filterOptions = '<option value="">全部节点</option>' + 
                        nodes.map(n => `<option value="${n.id}">${n.name} ${n.status === 'active' ? '' : '(离线)'}</option>`).join('');
                    $('#nodeFilter').html(filterOptions);
                }
            });
        }
        function loadContainers() {
            $('#containerTableBody').html('<tr><td colspan="9" class="text-center"><span class="loading loading-spinner loading-md"></span> 从缓存加载中...</td></tr>');
            $.get('/api/containers/cache', function(result) {
                if (result.code === 200) {
                    allContainers = result.data || [];
                    console.log('加载到的容器数据:', allContainers);
                    filterContainers();
                } else {
                    $('#containerTableBody').html(`<tr><td colspan="9" class="text-center text-error">加载失败: ${result.msg || '未知错误'}</td></tr>`);
                }
            }).fail(function(xhr) {
                console.error('加载容器失败:', xhr);
                $('#containerTableBody').html('<tr><td colspan="9" class="text-center text-error">加载失败，请检查服务连接</td></tr>');
            });
        }
        
        function formatSyncTime(timeStr) {
            if (!timeStr) return '未知';
            const time = new Date(timeStr);
            const now = new Date();
            const diff = Math.floor((now - time) / 1000);
            
            if (diff < 60) return '刚刚';
            if (diff < 3600) return Math.floor(diff / 60) + '分钟前';
            if (diff < 86400) return Math.floor(diff / 3600) + '小时前';
            return time.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
        
        function syncCurrentNode() {
            const nodeId = $('#nodeFilter').val();
            const nodeName = $('#nodeFilter option:selected').text();
            
            let confirmMsg, apiUrl;
            
            if (!nodeId) {
                confirmMsg = '确定要同步所有节点的容器信息吗？\n\n此操作将并发获取所有容器的最新状态，可能需要几秒钟时间。';
                apiUrl = '/api/sync/all';
            } else {
                confirmMsg = `确定要同步节点 "${nodeName}" 的容器信息吗？\n\n此操作将获取该节点所有容器的最新状态。`;
                apiUrl = `/api/sync/node/${nodeId}`;
            }
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            const $btn = $('#syncAllBtn');
            const originalHtml = $btn.html();
            $btn.html('<span class="loading loading-spinner loading-xs"></span> 同步中...').prop('disabled', true);
            
            $.ajax({
                url: apiUrl,
                type: 'POST',
                contentType: 'application/json',
                success: function(result) {
                    if (result.code === 200) {
                        showToast('success', result.msg || '同步任务已启动');
                        setTimeout(() => {
                            startSyncStatusPolling();
                        }, 3000);
                    } else {
                        showToast('error', result.msg || '同步启动失败');
                        $btn.html(originalHtml).prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    showToast('error', '同步启动失败，请检查网络连接');
                    $btn.html(originalHtml).prop('disabled', false);
                }
            });
        }
        
        let syncStatusInterval = null;
        
        function startSyncStatusPolling() {
            $('#syncStatusIndicator').removeClass('hidden');
            
            if (syncStatusInterval) {
                clearInterval(syncStatusInterval);
            }
            
            syncStatusInterval = setInterval(() => {
                $.get('/api/sync/status', function(result) {
                    if (result.code === 200) {
                        const statuses = result.data || [];
                        const syncing = statuses.some(s => s.syncing);
                        
                        if (syncing) {
                            const syncingNodes = statuses.filter(s => s.syncing).map(s => s.node_name).join(', ');
                            $('#syncStatusText').text(`正在同步: ${syncingNodes}`);
                        } else {
                            // 同步完成
                            clearInterval(syncStatusInterval);
                            syncStatusInterval = null;
                            $('#syncStatusIndicator').addClass('hidden');
                            $('#syncAllBtn').html(`
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span>同步所有节点</span>
                            `).prop('disabled', false);
                            
                            showToast('success', '同步完成！正在刷新数据...');
                            loadContainers();
                        }
                    }
                });
            }, 2000);
        }
        
        function showSyncHistory() {
            $.get('/api/sync/tasks', function(result) {
                if (result.code === 200) {
                    const tasks = result.data || [];
                    
                    let html = `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeModal(event)">
                            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-auto m-4" onclick="event.stopPropagation()">
                                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                                    <h2 class="text-2xl font-bold text-gray-800">同步历史记录</h2>
                                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                                </div>
                                <div class="p-6">
                    `;
                    
                    if (tasks.length === 0) {
                        html += '<p class="text-center text-gray-500 py-8">暂无同步记录</p>';
                    } else {
                        html += '<div class="space-y-4">';
                        tasks.forEach(task => {
                            const statusBadge = {
                                'completed': '<span class="badge badge-success badge-sm">成功</span>',
                                'failed': '<span class="badge badge-error badge-sm">失败</span>',
                                'running': '<span class="badge badge-info badge-sm">运行中</span>',
                                'pending': '<span class="badge badge-ghost badge-sm">等待中</span>'
                            };
                            
                            const startTime = task.start_time ? new Date(task.start_time).toLocaleString('zh-CN') : '-';
                            const endTime = task.end_time ? new Date(task.end_time).toLocaleString('zh-CN') : '-';
                            const duration = (task.start_time && task.end_time) 
                                ? `${Math.round((new Date(task.end_time) - new Date(task.start_time)) / 1000)}秒`
                                : '-';
                            
                            html += `
                                <div class="border rounded-lg p-4 hover:bg-gray-50">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <span class="font-semibold text-gray-800">${task.node_name}</span>
                                            ${statusBadge[task.status] || statusBadge.pending}
                                        </div>
                                        <span class="text-xs text-gray-500">${startTime}</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-4 text-sm mt-3">
                                        <div>
                                            <div class="text-gray-500 text-xs">总数</div>
                                            <div class="font-semibold">${task.total_count}</div>
                                        </div>
                                        <div>
                                            <div class="text-gray-500 text-xs">成功</div>
                                            <div class="font-semibold text-green-600">${task.success_count}</div>
                                        </div>
                                        <div>
                                            <div class="text-gray-500 text-xs">失败</div>
                                            <div class="font-semibold text-red-600">${task.failed_count}</div>
                                        </div>
                                        <div>
                                            <div class="text-gray-500 text-xs">耗时</div>
                                            <div class="font-semibold">${duration}</div>
                                        </div>
                                    </div>
                                    ${task.error_message ? `<div class="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded">${task.error_message}</div>` : ''}
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('body').append(html);
                } else {
                    showToast('error', '获取同步历史失败');
                }
            });
        }
        
        function closeModal(event) {
            if (event) event.stopPropagation();
            $('.fixed.inset-0').remove();
        }
        
        function showToast(type, message) {
            const colors = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'info': 'bg-blue-600'
            };
            
            const toast = $(`
                <div class="fixed top-4 right-4 ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in">
                    ${message}
                </div>
            `);
            
            $('body').append(toast);
            
            setTimeout(() => {
                toast.fadeOut(300, function() { $(this).remove(); });
            }, 3000);
        }
        function startContainer(name, nodeId) {
            if (!confirm(`确定要启动容器 ${name} 吗？`)) return;
            containerAction(name, nodeId, 'start', '启动');
        }
        function stopContainer(name, nodeId) {
            if (!confirm(`确定要停止容器 ${name} 吗？\n\n停止后容器内运行的服务将会中断。`)) return;
            containerAction(name, nodeId, 'stop', '停止');
        }
        function restartContainer(name, nodeId) {
            if (!confirm(`确定要重启容器 ${name} 吗？\n\n重启会导致容器短暂中断服务。`)) return;
            containerAction(name, nodeId, 'restart', '重启');
        }
        function deleteContainer(name, nodeId) {
            if (!confirm(`⚠️ 警告：确定要删除容器 ${name} 吗？\n\n删除后容器内的所有数据将永久丢失，此操作不可恢复！`)) return;
            containerAction(name, nodeId, 'delete', '删除');
        }
        function refreshSingleContainer(hostname, nodeId) {
            const $btn = $(`button[onclick="refreshSingleContainer('${hostname}', ${nodeId})"]`);
            const originalHtml = $btn.html();
            $btn.html('<span class="loading loading-spinner loading-xs"></span>').prop('disabled', true);
            
            $.ajax({
                url: `/api/containers/${hostname}/refresh?node_id=${nodeId}`,
                type: 'POST',
                success: function(result) {
                    $btn.html(originalHtml).prop('disabled', false);
                    if (result.code === 200) {
                        loadContainers();
                    } else {
                        alert('刷新失败: ' + (result.msg || '未知错误'));
                    }
                },
                error: function() {
                    $btn.html(originalHtml).prop('disabled', false);
                    alert('刷新失败，请检查网络连接');
                }
            });
        }
        function openConsole(hostname, nodeId) {
            const $btn = $(`button[onclick="openConsole('${hostname}', ${nodeId})"]`);
            const originalHtml = $btn.html();
            $btn.html('连接中...').prop('disabled', true);
            $.ajax({
                url: '/api/console/token',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    hostname: hostname,
                    node_id: nodeId
                }),
                success: function(result) {
                    $btn.html(originalHtml).prop('disabled', false);
                    if (result.code === 200) {
                        const consoleUrl = result.data.console_url;
                        const consoleWindow = window.open(consoleUrl, '_blank', 'width=1200,height=800,menubar=no,toolbar=no,location=no,status=no');
                        if (!consoleWindow) {
                            alert('无法打开控制台窗口，请检查浏览器弹窗拦截设置');
                        }
                    } else {
                        alert('获取控制台失败: ' + result.msg);
                    }
                },
                error: function(xhr) {
                    $btn.html(originalHtml).prop('disabled', false);
                    alert('获取控制台失败，请检查网络连接');
                }
            });
        }
        function containerAction(name, nodeId, action, actionName) {
            const $btn = $(`button[onclick="${action}Container('${name}', ${nodeId})"]`);
            const originalHtml = $btn.html();
            $btn.html('<span class="loading loading-spinner loading-xs"></span>').prop('disabled', true);
            
            $.post(`/api/containers/${name}/${action}?node_id=${nodeId}`, function(result) {
                $btn.html(originalHtml).prop('disabled', false);
                if (result.code === 200) {
                    alert(result.msg || `${actionName}成功`);
                    loadContainers();
                } else {
                    alert(`${actionName}失败: ` + (result.msg || '未知错误'));
                }
            }).fail(function() {
                $btn.html(originalHtml).prop('disabled', false);
                alert(`${actionName}失败，请检查网络连接`);
            });
        }
        
        // 容器详情相关
        let detailRefreshInterval = null;
        let currentDetailHostname = null;
        let currentDetailNodeId = null;
        
        function showContainerDetail(hostname, nodeId) {
            currentDetailHostname = hostname;
            currentDetailNodeId = nodeId;
            
            // 显示模态框
            document.getElementById('containerDetailModal').classList.remove('hidden');
            document.getElementById('detailHostname').textContent = hostname;
            
            // 加载详情
            loadContainerDetail(hostname, nodeId);
            
            // 开始定时刷新（每5秒）
            if (detailRefreshInterval) {
                clearInterval(detailRefreshInterval);
            }
            detailRefreshInterval = setInterval(() => {
                loadContainerDetail(hostname, nodeId);
            }, 10000);
        }
        
        function closeContainerDetail() {
            document.getElementById('containerDetailModal').classList.add('hidden');
            currentDetailHostname = null;
            currentDetailNodeId = null;
            if (detailRefreshInterval) {
                clearInterval(detailRefreshInterval);
                detailRefreshInterval = null;
            }
        }
        
        function manualRefreshDetail() {
            if (currentDetailHostname && currentDetailNodeId) {
                loadContainerDetail(currentDetailHostname, currentDetailNodeId);
            }
        }
        
        function loadContainerDetail(hostname, nodeId) {
            const $content = $('#detailContent');
            
            $.get(`/api/containers/${hostname}?node_id=${nodeId}`, function(result) {
                if (result.code === 200) {
                    const data = result.data;
                    const cpuColor = data.cpu_percent > 80 ? 'text-red-600' : data.cpu_percent > 50 ? 'text-orange-600' : 'text-green-600';
                    const memoryPercent = data.memory_percent || 0;
                    const diskPercent = data.disk_percent || 0;
                    
                    $content.html(`
                        <div class="space-y-4">
                            <!-- 基本信息 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-gray-700 mb-3">基本信息</h3>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div><span class="text-gray-600">容器名称:</span> <span class="font-medium">${data.hostname}</span></div>
                                    <div><span class="text-gray-600">状态:</span> <span class="badge ${data.status === 'Running' ? 'badge-success' : 'badge-ghost'} badge-sm">${data.status}</span></div>
                                    <div><span class="text-gray-600">IPv4:</span> <code class="text-xs bg-blue-50 px-2 py-1 rounded">${data.ipv4 || '-'}</code></div>
                                    <div><span class="text-gray-600">IPv6:</span> <code class="text-xs bg-blue-50 px-2 py-1 rounded">${data.ipv6 || '-'}</code></div>
                                    <div><span class="text-gray-600">镜像:</span> <span class="text-xs">${data.image || '-'}</span></div>
                                    <div><span class="text-gray-600">创建时间:</span> <span class="text-xs">${data.created_at ? new Date(data.created_at).toLocaleString('zh-CN') : '-'}</span></div>
                                </div>
                            </div>
                            
                            <!-- 资源配置 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-gray-700 mb-3">资源配置</h3>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div><span class="text-gray-600">CPU核心:</span> <span class="font-medium">${data.cpus || data.config?.cpus || '-'} 核</span></div>
                                    <div><span class="text-gray-600">内存:</span> <span class="font-medium">${data.config?.memory || data.memory + 'MB' || '-'}</span></div>
                                    <div><span class="text-gray-600">磁盘:</span> <span class="font-medium">${data.config?.disk || data.disk + 'MB' || '-'}</span></div>
                                    <div><span class="text-gray-600">流量限制:</span> <span class="font-medium">${data.config?.traffic_limit ? data.config.traffic_limit + ' GB' : '无限制'}</span></div>
                                </div>
                            </div>
                            
                            <!-- 实时使用情况 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-gray-700 mb-3">实时使用情况</h3>
                                <div class="space-y-3">
                                    <!-- CPU -->
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">CPU使用率</span>
                                            <span class="font-semibold ${cpuColor}">${data.cpus || data.config?.cpus || 1}核 (${(data.cpu_percent || data.cpu_usage || 0).toFixed(1)}%)</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="h-2 rounded-full transition-all" style="width: ${Math.min(data.cpu_percent || data.cpu_usage || 0, 100)}%; background: ${data.cpu_percent > 80 ? '#ef4444' : data.cpu_percent > 50 ? '#f59e0b' : '#10b981'}"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- 内存 -->
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">内存使用</span>
                                            <span class="font-medium">${data.memory_usage || '-'} / ${data.config?.memory || '-'} (${memoryPercent.toFixed(1)}%)</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="h-2 rounded-full transition-all" style="width: ${Math.min(memoryPercent, 100)}%; background: ${memoryPercent > 80 ? '#ef4444' : memoryPercent > 50 ? '#f59e0b' : '#10b981'}"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- 磁盘 -->
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">磁盘使用</span>
                                            <span class="font-medium">${data.disk_usage || '-'} / ${data.config?.disk || '-'} (${diskPercent.toFixed(1)}%)</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="h-2 rounded-full transition-all" style="width: ${Math.min(diskPercent, 100)}%; background: ${diskPercent > 80 ? '#ef4444' : diskPercent > 50 ? '#f59e0b' : '#10b981'}"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- 流量 -->
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">流量使用</span>
                                            <span class="font-medium">${data.traffic_usage || '0 B'}${data.config?.traffic_limit ? (() => {
                                                const trafficBytes = data.traffic_usage_raw || 0;
                                                const limitBytes = data.config.traffic_limit * 1024 * 1024 * 1024;
                                                const trafficPercent = (trafficBytes / limitBytes * 100).toFixed(1);
                                                return ' / ' + data.config.traffic_limit + ' GB (' + trafficPercent + '%)';
                                            })() : ''}</span>
                                        </div>
                                        ${data.config?.traffic_limit ? (() => {
                                            const trafficBytes = data.traffic_usage_raw || 0;
                                            const limitBytes = data.config.traffic_limit * 1024 * 1024 * 1024;
                                            const trafficPercent = (trafficBytes / limitBytes * 100).toFixed(1);
                                            return `
                                                <div class="w-full bg-gray-200 rounded-full h-2">
                                                    <div class="h-2 rounded-full transition-all" style="width: ${Math.min(trafficPercent, 100)}%; background: ${trafficPercent > 80 ? '#ef4444' : trafficPercent > 50 ? '#f59e0b' : '#10b981'}"></div>
                                                </div>
                                            `;
                                        })() : '<div class="text-xs text-gray-400">-</div>'}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 最后更新时间 -->
                            <div class="text-xs text-gray-500 text-center">
                                <span>最后更新: ${data.last_update || new Date().toLocaleTimeString('zh-CN')}</span>
                                <span class="ml-2">每10秒自动刷新</span>
                            </div>
                        </div>
                    `);
                } else {
                    $content.html(`<div class="text-center text-red-600 py-8">加载失败: ${result.msg}</div>`);
                }
            }).fail(function() {
                $content.html(`<div class="text-center text-red-600 py-8">网络错误，请检查连接</div>`);
            });
        }

        function showCreateContainer() {
            $.get('/api/nodes', function(result) {
                if (result.code === 200) {
                    const nodes = result.data || [];
                    const options = nodes
                        .filter(n => n.status === 'active')
                        .map(n => `<option value="${n.id}">${n.name}</option>`)
                        .join('');
                    $('#createNodeSelect').html('<option value="">选择节点</option>' + options);
                }
            });
            document.getElementById('createContainerModal').classList.remove('hidden');
            document.getElementById('createContainerForm').reset();
        }

        function closeCreateContainer() {
            document.getElementById('createContainerModal').classList.add('hidden');
        }

        function submitCreateContainer() {
            const form = document.getElementById('createContainerForm');
            if (!form.checkValidity()) {
                alert('请填写所有必填项');
                return;
            }

            const formData = new FormData(form);
            const data = {
                node_id: parseInt(formData.get('node_id')),
                hostname: formData.get('hostname'),
                password: formData.get('password'),
                image: formData.get('image'),
                cpus: parseInt(formData.get('cpus')),
                memory: formData.get('memory'),
                disk: formData.get('disk'),
                ingress: formData.get('ingress'),
                egress: formData.get('egress'),
                traffic_limit: parseInt(formData.get('traffic_limit')),
                allow_nesting: formData.get('allow_nesting') === 'on',
                memory_swap: formData.get('memory_swap') === 'on'
            };

            if (!data.node_id) {
                alert('请选择节点');
                return;
            }

            const $submitBtn = $('button[onclick="submitCreateContainer()"]');
            const originalHtml = $submitBtn.html();
            $submitBtn.html('<span class="loading loading-spinner loading-xs"></span> 创建中...').prop('disabled', true);

            $.ajax({
                url: '/api/containers/create',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(result) {
                    $submitBtn.html(originalHtml).prop('disabled', false);
                    if (result.code === 200) {
                        alert('容器创建成功！');
                        closeCreateContainer();
                        setTimeout(() => {
                            loadContainers();
                        }, 2000);
                    } else {
                        alert('创建失败: ' + (result.msg || '未知错误'));
                    }
                },
                error: function(xhr) {
                    $submitBtn.html(originalHtml).prop('disabled', false);
                    const response = xhr.responseJSON;
                    alert('创建失败: ' + (response?.msg || '网络错误'));
                }
            });
        }
    </script>
</body>
</html>
