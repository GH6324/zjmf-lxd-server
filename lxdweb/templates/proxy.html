<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-gray-50">
    {{template "header.html" .}}
    
    <!-- 创建Proxy配置模态框 -->
    <div id="createProxyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" onclick="if(event.target === this) closeCreateProxy()">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-indigo-600 to-indigo-700">
                <h2 class="text-xl font-bold text-white">创建反向代理配置</h2>
            </div>
            <div class="p-6">
                <form id="createProxyForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">节点 *</label>
                        <select name="node_id" required id="createProxyNodeSelect" onchange="loadContainersForProxy(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">选择节点</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">容器 *</label>
                        <select name="container_hostname" required id="createProxyContainerSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">请先选择节点</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">域名 *</label>
                        <input type="text" name="domain" required pattern="^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如: example.com">
                        <p class="text-xs text-gray-500 mt-1">需要完整的域名格式</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">容器端口 *</label>
                        <input type="number" name="container_port" required min="1" max="65535" value="80" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如: 80">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                        <input type="text" name="description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="可选">
                    </div>
                </form>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-2">
                <button onclick="closeCreateProxy()" class="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-100 transition">取消</button>
                <button onclick="submitCreateProxy()" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">创建配置</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">反向代理管理</h1>
                <div class="flex items-center gap-3 mt-1">
                    <p class="text-gray-600">管理和监控所有节点的反向代理配置</p>
                    <div id="proxySyncStatusIndicator" class="hidden">
                        <span class="flex items-center gap-2 text-sm text-blue-600">
                            <span class="loading loading-spinner loading-xs"></span>
                            <span id="proxySyncStatusText">正在同步中...</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="showCreateProxy()" class="btn-action bg-indigo-500 hover:bg-indigo-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span>创建配置</span>
                </button>
                <button onclick="loadProxyConfigs()" class="btn-action bg-gray-500 hover:bg-gray-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>刷新页面</span>
                </button>
                <button onclick="syncCurrentNode()" id="syncAllProxyBtn" class="btn-action bg-green-500 hover:bg-green-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>同步当前节点</span>
                </button>
                <button onclick="showProxySyncHistory()" class="btn-action bg-blue-500 hover:bg-blue-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>同步历史</span>
                </button>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">节点筛选:</label>
                    <select id="nodeFilter" onchange="filterConfigs()" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                        <option value="">全部节点</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">SSL筛选:</label>
                    <select id="sslFilter" onchange="filterConfigs()" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                        <option value="">全部</option>
                        <option value="true">已启用</option>
                        <option value="false">未启用</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 flex-1">
                    <label class="text-sm font-medium text-gray-700">搜索:</label>
                    <input type="text" id="searchInput" oninput="filterConfigs()" placeholder="容器名称或域名" class="px-3 py-1 border border-gray-300 rounded-lg text-sm flex-1 max-w-xs">
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">每页:</label>
                    <select id="pageSize" onchange="changePageSize()" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                        <option value="25">25条</option>
                        <option value="50" selected>50条</option>
                        <option value="100">100条</option>
                        <option value="300">300条</option>
                    </select>
                </div>
                <div class="flex gap-6 ml-auto">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-800" id="totalCount">0</div>
                        <div class="text-xs text-gray-500">总配置</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="sslCount">0</div>
                        <div class="text-xs text-gray-500">SSL启用</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
            <div class="overflow-x-auto">
                    <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>节点</th>
                            <th>容器</th>
                            <th>域名</th>
                            <th>后端端口</th>
                            <th>SSL</th>
                            <th>状态</th>
                            <th>最后同步</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                        <tbody id="proxyTableBody">
                        <tr>
                                <td colspan="8" class="text-center">加载中...</td>
                        </tr>
                    </tbody>
                </table>
                </div>
            </div>
            <div class="border-t px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-600">
                        显示第 <span id="pageStartNum">0</span> - <span id="pageEndNum">0</span> 条，共 <span id="filteredCount">0</span> 条
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="goToPage(1)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" id="firstPageBtn">
                            首页
                        </button>
                        <button onclick="goToPage(currentPage - 1)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" id="prevPageBtn">
                            上一页
                        </button>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">第</span>
                            <input type="number" id="pageInput" min="1" value="1" class="w-16 px-2 py-1 text-sm text-center border border-gray-300 rounded" onkeypress="handlePageInputEnter(event)">
                            <span class="text-sm text-gray-600">/ <span id="totalPages">1</span> 页</span>
                            <button onclick="goToInputPage()" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                跳转
                            </button>
                        </div>
                        <button onclick="goToPage(currentPage + 1)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" id="nextPageBtn">
                            下一页
                        </button>
                        <button onclick="goToPage(totalPagesCount)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" id="lastPageBtn">
                            末页
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
        .btn-action {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            border-radius: 0.5rem;
            transition: all 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .btn-action:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-action svg {
            flex-shrink: 0;
        }
        
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
    </style>
    <script>
        let nodes = [];
        let allConfigs = [];
        let filteredConfigs = [];
        let currentPage = 1;
        let pageSize = 50;
        let totalPagesCount = 1;

        $(document).ready(function() {
            loadNodes();
            loadProxyConfigs();
        });
        
        function renderConfigs(configs) {
            filteredConfigs = configs;
            
            totalPagesCount = Math.ceil(configs.length / pageSize);
            if (totalPagesCount === 0) totalPagesCount = 1;
            
            if (currentPage > totalPagesCount) {
                currentPage = totalPagesCount;
            }
            
            updateStats(configs);
            updatePaginationInfo(configs.length);
            
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, configs.length);
            const pageConfigs = configs.slice(startIndex, endIndex);
            
            if (pageConfigs.length === 0) {
                $('#proxyTableBody').html('<tr><td colspan="8" class="text-center text-gray-500">暂无反向代理配置数据</td></tr>');
                return;
            }

            const rows = pageConfigs.map(config => {
                const sslBadge = config.ssl_enabled 
                    ? '<span class="badge badge-success badge-sm">✓ 启用</span>'
                    : '<span class="badge badge-ghost badge-sm">✗ 未启用</span>';
                
                const statusBadge = config.status === 'active' 
                    ? '<span class="badge badge-success badge-sm">活跃</span>'
                    : '<span class="badge badge-ghost badge-sm">未知</span>';
                
                const lastSync = config.last_sync 
                    ? new Date(config.last_sync).toLocaleString('zh-CN')
                    : '-';

                return `
                    <tr class="hover:bg-gray-50">
                        <td>
                            <span class="badge badge-outline badge-sm">${config.node_name || '-'}</span>
                        </td>
                        <td>
                            <div class="font-semibold text-gray-800">${config.hostname || '-'}</div>
                        </td>
                        <td>
                            <code class="text-sm bg-blue-50 px-2 py-1 rounded font-mono">${config.domain || '-'}</code>
                        </td>
                        <td class="text-center text-sm">${config.backend_port || '-'}</td>
                        <td>${sslBadge}</td>
                        <td>${statusBadge}</td>
                        <td class="text-sm text-gray-600">${lastSync}</td>
                        <td class="text-center">
                            <button onclick="deleteProxy(${config.id})" class="btn btn-sm btn-error btn-outline">删除</button>
                        </td>
                    </tr>
                `;
            }).join('');
            $('#proxyTableBody').html(rows);
        }
        
        function updatePaginationInfo(totalCount) {
            const startNum = totalCount === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const endNum = Math.min(currentPage * pageSize, totalCount);
            
            $('#pageStartNum').text(startNum);
            $('#pageEndNum').text(endNum);
            $('#filteredCount').text(totalCount);
            $('#totalPages').text(totalPagesCount);
            $('#pageInput').val(currentPage);
            $('#pageInput').attr('max', totalPagesCount);
            
            $('#firstPageBtn, #prevPageBtn').prop('disabled', currentPage === 1);
            $('#nextPageBtn, #lastPageBtn').prop('disabled', currentPage === totalPagesCount);
        }
        
        function changePageSize() {
            pageSize = parseInt($('#pageSize').val());
            currentPage = 1;
            renderConfigs(filteredConfigs);
        }
        
        function goToPage(page) {
            if (page < 1 || page > totalPagesCount) return;
            currentPage = page;
            renderConfigs(filteredConfigs);
            $('html, body').animate({
                scrollTop: $('.bg-white.rounded-lg.shadow').offset().top - 100
            }, 300);
        }
        
        function goToInputPage() {
            const page = parseInt($('#pageInput').val());
            if (!isNaN(page)) {
                goToPage(page);
            }
        }
        
        function handlePageInputEnter(event) {
            if (event.keyCode === 13) {
                goToInputPage();
            }
        }
        
        function updateStats(configs) {
            const total = configs.length;
            const sslEnabled = configs.filter(c => c.ssl_enabled).length;
            $('#totalCount').text(total);
            $('#sslCount').text(sslEnabled);
        }
        
        function filterConfigs() {
            const nodeFilter = $('#nodeFilter').val();
            const sslFilter = $('#sslFilter').val();
            const searchText = $('#searchInput').val().toLowerCase();
            let filtered = allConfigs;
            
            if (nodeFilter) {
                filtered = filtered.filter(c => c.node_id == nodeFilter);
            }
            if (sslFilter) {
                const sslValue = sslFilter === 'true';
                filtered = filtered.filter(c => c.ssl_enabled === sslValue);
            }
            if (searchText) {
                filtered = filtered.filter(c => 
                    (c.hostname && c.hostname.toLowerCase().includes(searchText)) ||
                    (c.domain && c.domain.toLowerCase().includes(searchText))
                );
            }
            currentPage = 1;
            renderConfigs(filtered);
        }
        
        function loadNodes() {
            $.get('/api/nodes', function(result) {
                if (result.code === 200) {
                    nodes = result.data;
                    const filterOptions = '<option value="">全部节点</option>' + 
                        nodes.map(n => `<option value="${n.id}">${n.name} ${n.status === 'active' ? '' : '(离线)'}</option>`).join('');
                    $('#nodeFilter').html(filterOptions);
                }
            });
        }
        
        function loadProxyConfigs() {
            $('#proxyTableBody').html('<tr><td colspan="8" class="text-center"><span class="loading loading-spinner loading-md"></span> 从缓存加载中...</td></tr>');
            $.get('/api/proxy-configs/cache', function(result) {
                if (result.code === 200) {
                    allConfigs = result.data || [];
                    console.log('加载到的代理配置:', allConfigs);
                    currentPage = 1;
                    filterConfigs();
                } else {
                    $('#proxyTableBody').html(`<tr><td colspan="8" class="text-center text-error">加载失败: ${result.msg}</td></tr>`);
                }
            }).fail(function() {
                $('#proxyTableBody').html('<tr><td colspan="8" class="text-center text-error">加载失败</td></tr>');
            });
        }
        
        function syncCurrentNode() {
            const nodeId = $('#nodeFilter').val();
            const nodeName = $('#nodeFilter option:selected').text();
            
            let confirmMsg, apiUrl;
            
            if (!nodeId) {
                confirmMsg = '确定要同步所有节点的反向代理配置吗？\n\n此操作将从各节点获取最新的反向代理配置。';
                apiUrl = '/api/proxy-sync/all';
            } else {
                confirmMsg = `确定要同步节点 "${nodeName}" 的反向代理配置吗？\n\n此操作将获取该节点的最新反向代理配置。`;
                apiUrl = `/api/proxy-configs/sync?node_id=${nodeId}`;
            }
            
            if (!confirm(confirmMsg)) {
                return;
            }

            const $btn = $('#syncAllProxyBtn');
            const originalHtml = $btn.html();
            $btn.html('<span class="loading loading-spinner loading-xs"></span> 同步中...').prop('disabled', true);
            
            $.ajax({
                url: apiUrl,
                type: 'POST',
                contentType: 'application/json',
                success: function(result) {
                    if (result.code === 200) {
                        showToast('success', result.msg || '代理配置同步任务已启动');
                        setTimeout(() => {
                            startProxySyncStatusPolling();
                        }, 3000);
                    } else {
                        showToast('error', result.msg || '同步启动失败');
                        $btn.html(originalHtml).prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    showToast('error', '同步启动失败，请检查网络连接');
                    $btn.html(originalHtml).prop('disabled', false);
                }
            });
        }
        
        let proxySyncStatusInterval = null;
        
        function startProxySyncStatusPolling() {
            $('#proxySyncStatusIndicator').removeClass('hidden');
            
            if (proxySyncStatusInterval) {
                clearInterval(proxySyncStatusInterval);
            }
            
            proxySyncStatusInterval = setInterval(() => {
                $.get('/api/proxy-sync/status', function(result) {
                    if (result.code === 200) {
                        const statuses = result.data || [];
                        const syncing = statuses.some(s => s.syncing);
                        
                        if (syncing) {
                            const syncingNodes = statuses.filter(s => s.syncing).map(s => s.node_name).join(', ');
                            $('#proxySyncStatusText').text(`正在同步: ${syncingNodes}`);
                        } else {
                            clearInterval(proxySyncStatusInterval);
                            proxySyncStatusInterval = null;
                            $('#proxySyncStatusIndicator').addClass('hidden');
                            $('#syncAllProxyBtn').html(`
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span>同步所有节点</span>
                            `).prop('disabled', false);
                            
                            showToast('success', '代理配置同步完成！正在刷新数据...');
                            loadProxyConfigs();
                        }
                    }
                });
            }, 2000);
        }
        
        function showProxySyncHistory() {
            $.get('/api/proxy-sync/tasks', function(result) {
                if (result.code === 200) {
                    const tasks = result.data || [];
                    
                    let html = `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeModal(event)">
                            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-auto m-4" onclick="event.stopPropagation()">
                                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                                    <h2 class="text-2xl font-bold text-gray-800">反向代理同步历史</h2>
                                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                                </div>
                                <div class="p-6">
                    `;
                    
                    if (tasks.length === 0) {
                        html += '<p class="text-center text-gray-500 py-8">暂无同步记录</p>';
                    } else {
                        html += '<div class="space-y-4">';
                        tasks.forEach(task => {
                            const statusBadge = {
                                'completed': '<span class="badge badge-success badge-sm">成功</span>',
                                'failed': '<span class="badge badge-error badge-sm">失败</span>',
                                'running': '<span class="badge badge-info badge-sm">运行中</span>',
                                'pending': '<span class="badge badge-ghost badge-sm">等待中</span>'
                            };
                            
                            const startTime = task.start_time ? new Date(task.start_time).toLocaleString('zh-CN') : '-';
                            const duration = (task.start_time && task.end_time) 
                                ? `${Math.round((new Date(task.end_time) - new Date(task.start_time)) / 1000)}秒`
                                : '-';
                            
                            html += `
                                <div class="border rounded-lg p-4 hover:bg-gray-50">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <span class="font-semibold text-gray-800">${task.node_name}</span>
                                            ${statusBadge[task.status] || statusBadge.pending}
                                        </div>
                                        <span class="text-xs text-gray-500">${startTime}</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-4 text-sm mt-3">
                                        <div>
                                            <div class="text-gray-500 text-xs">总数</div>
                                            <div class="font-semibold">${task.total_count}</div>
                                        </div>
                                        <div>
                                            <div class="text-gray-500 text-xs">成功</div>
                                            <div class="font-semibold text-green-600">${task.success_count}</div>
                                        </div>
                                        <div>
                                            <div class="text-gray-500 text-xs">失败</div>
                                            <div class="font-semibold text-red-600">${task.failed_count}</div>
                                        </div>
                                        <div>
                                            <div class="text-gray-500 text-xs">耗时</div>
                                            <div class="font-semibold">${duration}</div>
                                        </div>
                                    </div>
                                    ${task.error_message ? `<div class="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded">${task.error_message}</div>` : ''}
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('body').append(html);
                } else {
                    showToast('error', '获取同步历史失败');
                }
            });
        }
        
        function closeModal(event) {
            if (event) event.stopPropagation();
            $('.fixed.inset-0').remove();
        }
        
        function showToast(type, message) {
            const colors = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'info': 'bg-blue-600'
            };
            
            const toast = $(`
                <div class="fixed top-4 right-4 ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in">
                    ${message}
                </div>
            `);
            
            $('body').append(toast);
            
            setTimeout(() => {
                toast.fadeOut(300, function() { $(this).remove(); });
            }, 3000);
        }

        function showCreateProxy() {
            $.get('/api/nodes', function(result) {
                if (result.code === 200) {
                    const nodes = result.data || [];
                    const options = nodes.filter(n => n.status === 'active')
                        .map(n => `<option value="${n.id}">${n.name}</option>`).join('');
                    $('#createProxyNodeSelect').html('<option value="">选择节点</option>' + options);
                }
            });
            document.getElementById('createProxyModal').classList.remove('hidden');
            document.getElementById('createProxyForm').reset();
            $('#createProxyContainerSelect').html('<option value="">请先选择节点</option>');
        }

        function closeCreateProxy() {
            document.getElementById('createProxyModal').classList.add('hidden');
        }

        function loadContainersForProxy(nodeId) {
            if (!nodeId) {
                $('#createProxyContainerSelect').html('<option value="">请先选择节点</option>');
                return;
            }
            $.get(`/api/containers/cache?node_id=${nodeId}`, function(result) {
                if (result.code === 200) {
                    const containers = result.data || [];
                    const options = containers.filter(c => c.status === 'Running')
                        .map(c => `<option value="${c.hostname}">${c.hostname} (${c.ipv4 || '-'})</option>`).join('');
                    $('#createProxyContainerSelect').html('<option value="">选择容器</option>' + options);
                }
            });
        }

        function submitCreateProxy() {
            const form = document.getElementById('createProxyForm');
            if (!form.checkValidity()) {
                alert('请填写所有必填项');
                return;
            }
            const formData = new FormData(form);
            const data = {
                node_id: parseInt(formData.get('node_id')),
                container_hostname: formData.get('container_hostname'),
                domain: formData.get('domain'),
                container_port: parseInt(formData.get('container_port')),
                description: formData.get('description') || ''
            };
            const $submitBtn = $('button[onclick="submitCreateProxy()"]');
            const originalHtml = $submitBtn.html();
            $submitBtn.html('<span class="loading loading-spinner loading-xs"></span> 创建中...').prop('disabled', true);
            $.ajax({
                url: '/api/proxy-configs',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(result) {
                    $submitBtn.html(originalHtml).prop('disabled', false);
                    if (result.code === 200) {
                        alert('反向代理创建成功！');
                        closeCreateProxy();
                        setTimeout(() => loadProxyConfigs(), 1000);
                    } else {
                        alert('创建失败: ' + (result.msg || '未知错误'));
                    }
                },
                error: function(xhr) {
                    $submitBtn.html(originalHtml).prop('disabled', false);
                    alert('创建失败: ' + (xhr.responseJSON?.msg || '网络错误'));
                }
            });
        }

        function deleteProxy(id) {
            if (!confirm('确定要删除这个反向代理配置吗？\n\n删除后无法恢复。')) return;
            $.ajax({
                url: `/api/proxy-configs/${id}`,
                type: 'DELETE',
                success: function(result) {
                    if (result.code === 200) {
                        alert('删除成功');
                        loadProxyConfigs();
                    } else {
                        alert('删除失败: ' + (result.msg || '未知错误'));
                    }
                },
                error: function() {
                    alert('删除失败，请检查网络连接');
                }
            });
        }
    </script>
</body>
</html>
