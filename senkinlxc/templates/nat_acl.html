<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
    <link href="https://cdn.bootcdn.net/ajax/libs/mdui/1.0.2/css/mdui.min.css" rel="stylesheet">
    <title>NAT转发</title>
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .mdui-table th, .mdui-table td {
            text-align: center;
        }
        .actions-cell {
            width: 100px;
        }
        .mdui-dialog-title {
            font-size: 20px;
        }
        .mdui-dialog-content .mdui-textfield {
            margin-bottom: 16px;
        }
    </style>
</head>
<body class="mdui-theme-primary-indigo mdui-theme-accent-pink">

<div class="mdui-container">
    <div class="mdui-typo" style="margin-bottom: 16px;">
        <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" mdui-dialog="{target: '#addNatRuleDialog'}">
            <i class="mdui-icon material-icons">add</i> 创建NAT转发
        </button>
    </div>

    <div class="mdui-table-fluid">
        <table class="mdui-table mdui-table-hoverable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>外网端口</th>
                    <th>内网端口</th>
                    <th>协议</th>
                    <th class="actions-cell">管理</th>
                </tr>
            </thead>
            <tbody>
                {if empty($list)}
                <tr>
                    <td colspan="5" class="mdui-text-center">暂无NAT转发规则</td>
                </tr>
                {else}
                {foreach $list as $index => $rule }
                <tr>
                    <td>{$index+1}</td>
                    <td>{$rule.Dport}</td>
                    <td>{$rule.Sport}</td>
                    <td>{$rule.Dtype|upper}</td>
                    <td class="actions-cell">
                        <button class="mdui-btn mdui-btn-icon mdui-ripple mdui-text-color-red-accent"
                                onclick="confirmDeleteNatRule('{$rule.Dtype}', '{$rule.Dport}', '{$rule.Sport}')">
                            <i class="mdui-icon material-icons">delete</i>
                        </button>
                    </td>
                </tr>
                {/foreach}
                {/if}
            </tbody>
        </table>
    </div>
</div>

<div class="mdui-dialog" id="addNatRuleDialog">
    <div class="mdui-dialog-title">创建NAT转发规则</div>
    <div class="mdui-dialog-content">
        <form id="addNatRuleForm">
            <div class="mdui-textfield mdui-textfield-floating-label">
                <label class="mdui-textfield-label">外网端口 (10000-65535)</label>
                <input class="mdui-textfield-input" type="number" name="dport" min="10000" max="65535" required/>
                <div class="mdui-textfield-error">请输入有效的外网端口</div>
            </div>
            <div class="mdui-textfield mdui-textfield-floating-label">
                <label class="mdui-textfield-label">内网端口 (1-65535)</label>
                <input class="mdui-textfield-input" type="number" name="sport" min="1" max="65535" required/>
                <div class="mdui-textfield-error">请输入有效的内网端口</div>
            </div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label" style="top: -8px;">映射类型</label>
                 <select class="mdui-select" name="dtype" mdui-select="{position: 'bottom'}">
                    <option value="tcp" selected>TCP</option>
                    <option value="udp">UDP</option>
                </select>
            </div>
        </form>
    </div>
    <div class="mdui-dialog-actions">
        <button class="mdui-btn mdui-ripple" mdui-dialog-close>取消</button>
        <button class="mdui-btn mdui-ripple mdui-color-theme-accent" onclick="submitAddNatRule()">确定</button>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/mdui/1.0.2/js/mdui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  var $$ = mdui.$;

  function showLoading(title = '请稍候...') {
    Swal.fire({
      title: title,
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });
  }

  function hideLoading() {
    Swal.close();
  }

  function ajaxRequest(options) {
    showLoading(options.loadingTitle || '处理中...');
    var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft,XMLHTTP");
    var formData = "";
    if (typeof options.data === 'string') {
      formData = options.data;
    } else {
      var parts = [];
      for (var key in options.data) {
        parts.push(encodeURIComponent(key) + "=" + encodeURIComponent(options.data[key]));
      }
      formData = parts.join("&");
    }

    xhr.open(options.type.toUpperCase(), options.url, true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    if (options.headers) {
        for(var headerKey in options.headers) {
            xhr.setRequestHeader(headerKey, options.headers[headerKey]);
        }
    }

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        hideLoading();
        if (xhr.status === 200) {
          try {
            var response = JSON.parse(xhr.responseText);
            options.success && options.success(response);
          } catch (e) {
            options.error && options.error(xhr.status, "响应解析失败: " + e.message, xhr.responseText);
          }
        } else {
          options.error && options.error(xhr.status, "请求失败", xhr.responseText);
        }
      }
    };
    xhr.send(formData);
  }

  function submitAddNatRule() {
    var form = document.getElementById('addNatRuleForm');
    var dportInput = form.querySelector('input[name="dport"]');
    var sportInput = form.querySelector('input[name="sport"]');

    var isValid = true;
    if (!dportInput.checkValidity()) {
        $$(dportInput).parent().addClass('mdui-textfield-invalid');
        isValid = false;
    } else {
        $$(dportInput).parent().removeClass('mdui-textfield-invalid');
    }
    if (!sportInput.checkValidity()) {
        $$(sportInput).parent().addClass('mdui-textfield-invalid');
        isValid = false;
    } else {
        $$(sportInput).parent().removeClass('mdui-textfield-invalid');
    }

    if (!isValid) return;

    var formData = new FormData(form);
    var data = {};
    formData.forEach(function(value, key){
        data[key] = value;
    });
    data['func'] = 'natadd';

    ajaxRequest({
      type: "post",
      url: "{$MODULE_CUSTOM_API}",
      data: data,
      loadingTitle: '正在创建规则...',
      success: function (response) {
        if (response.status === 'success') {
          Swal.fire({
            icon: 'success',
            title: response.msg || '创建成功',
            confirmButtonText: '好的'
          }).then(function() {
            window.location.reload();
          });
          var dialog = new mdui.Dialog('#addNatRuleDialog');
          dialog.close();
        } else {
          Swal.fire('创建失败', response.msg || '未知错误', 'error');
        }
      },
      error: function (status, msg) {
        Swal.fire('请求错误', msg + ' (状态码: ' + status + ')', 'error');
      }
    });
  }

  function confirmDeleteNatRule(dtype, dport, sport) {
    Swal.fire({
      title: '确定删除此转发规则吗？',
      text: "外网端口: " + dport + ", 内网端口: " + sport + ", 协议: " + dtype.toUpperCase(),
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: '确认删除',
      cancelButtonText: '取消'
    }).then(function(result) {
      if (result.isConfirmed) {
        deleteNatRule(dtype, dport, sport);
      }
    });
  }

  function deleteNatRule(dtype, dport, sport) {
    ajaxRequest({
      type: "post",
      url: "{$MODULE_CUSTOM_API}",
      data: { "func": "natdel", "dtype": dtype, "dport": dport, "sport": sport },
      loadingTitle: '正在删除规则...',
      success: function (response) {
        if (response.status === 'success') {
          Swal.fire({
            icon: 'success',
            title: response.msg || '删除成功',
            confirmButtonText: '好的'
          }).then(function() {
            window.location.reload();
          });
        } else {
          Swal.fire('删除失败', response.msg || '未知错误', 'error');
        }
      },
      error: function (status, msg) {
        Swal.fire('请求错误', msg + ' (状态码: ' + status + ')', 'error');
      }
    });
  }
   $$(function () {
        mdui.mutation();
    });
</script>
</body>
</html>